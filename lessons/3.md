# Testando o fluxo de _Login_

Para o teste da funcionalidade de _login_, precisamos de um usu√°rio j√° cadastrado. Sugiro usar um que tenha sido criado durante o teste da funcionalidade de _Sign up_. Voc√™ pode obter os emails cadastrados em seu _server_ no Mailosaur.

## Exerc√≠cio

1. Atualize o conte√∫do do arquivo `cypress.env.json` adicionando a propriedade `USER_EMAIL` com o valor de um dos e-mails obtidos em seu _server_ no Mailosaur
2. Atualize tamb√©m o conte√∫do do arquivo `cypress.env.example.json` com o seguinte:

```json
{
  "USER_EMAIL": "a-valid-email@your-mailosaur-id.mailosaur.net",
  "USER_PASSWORD": "s3Cre7P@sSw0rd",
  "MAILOSAUR_SERVER_ID": "your-mailosaur-id-here",
  "MAILOSAUR_API_KEY": "your-mailosaur-api-key-here"
}
```

> **Obs.:** Lembre-se, neste arquivo, pode deixar os valores conforme acima. N√£o exponha dados sens√≠veis neste arquivo visto que ele ser√° versionado. A id√©ia √© ele ser um arquivo de exemplo, conforme seu nome sugere.

3. No diret√≥rio `cypress/e2e/`, crie um arquivo chamado `login.cy.js` com o seguinte conte√∫do:

```js
// cypress/e2e/login.cy.js

describe('Login', () => {
  it('successfully logs in', () => {
    cy.intercept('GET', '**/notes').as('getNotes')

    cy.visit('/login')
    cy.get('#email').type(Cypress.env('USER_EMAIL'))
    cy.get('#password').type(Cypress.env('USER_PASSWORD'))
    cy.contains('button', 'Login').click()
    cy.wait('@getNotes')

    cy.contains('h1', 'Your Notes').should('be.visible')
    cy.contains('a', 'Create a new note').should('be.visible')
  })
})

```

4. Execute o teste rec√©m criado com o comando `npx cypress run --spec cypress/e2e/login.cy.js`

> **Obs. 2:** Siga adiante para o exerc√≠cio extra quando o teste estiver passando.

## Exerc√≠cio extra 1 - protegendo dados sens√≠veis ainda mais

√â uma boa pr√°tica em automa√ß√£o de testes n√£o expor dados sens√≠veis em arquivos de teste, e j√° estamos fazendo isso com o uso de vari√°veis, as quais podem ser obtidas com o uso do comando `Cypress.env('VARIAVEL')`.

No entanto, quando o teste √© executado em modo interativo, a senha "vaza" no log de comandos do Cypress. Teste para ver abrindo a __Cypress App__ com o comando `npx cypress open`, execute o teste de _login_ e verifique a senha "vazando" no log de comandos.

Teu exerc√≠cio √© alterar a linha do teste que preenche a senha (`cy.get('#password').type(Cypress.env('USER_PASSWORD'))`) pelo seguinte `cy.get('#password').type(Cypress.env('USER_PASSWORD'), { log: false })`.

Execute o teste em modo interativo de novo e veja que agora a senha n√£o "vaza" mais.

## Exerc√≠cio extra 2 - Movendo a l√≥gica de _login_ para um comando customizado

1. No arquivo `cypress/support/commands.js`, crie um comando customizado chamado `login`, o qual recebe dois par√¢metros, `username` e `password`
2. Mova os comandos de _login_ para tal comando
3. Atualize o teste para chamar o comando customizado rec√©m criado
4. Execute o teste ap√≥s a refatora√ß√£o para garantir que tudo continua funcionando

> **Sugest√£o:** Aproveite que o _login_ foi abstra√≠do para um comando customizado e defina valores _default_ para os par√¢metros `username` e `password`, caso estes n√£o sejam passados como argumentos.

## Exerc√≠cio extra 3 - [`cy.session`](https://docs.cypress.io/api/commands/session)

Legal! Cobrimos o caminho feliz do fluxo de _login_, estamos protegendo bem os dados sens√≠veis e a l√≥gica do _login_ est√° em um comando customizado que agora pode ser re-aproveitado.

**Abre par√™nteses.**

Os testes de CRUD, preenchimento do formul√°rio de cart√£o de cr√©dito e _Logout_ tamb√©m precisar√£o do usu√°rio autenticado no sistema.

Mas fazer o _login_ pela interface gr√°fica de usu√°rio (GUI) para testes que dependem de tal fluxo como pre-condic√£o √© uma "m√° pr√°tica", visto que torna os testes depedentes e mais lentos do que necess√°rio.

Idealmente, ter√≠amos que testar o fluxo de _login_ via GUI somente uma vez.

**Fecha par√™nteses.**

E se consegu√≠semos armazenar a sess√£o do usu√°rio no cache e ent√£o restaur√°-la antes de cada teste?

Na vers√£o [8.2.0](https://docs.cypress.io/guides/references/changelog#8-2-0), o Cypress lan√ßou a funcionalidade `cy.session` como uma funcionalidade experimental para nos ajudar exatamente com isso. E na vers√£o [12.0.0](https://docs.cypress.io/guides/references/changelog#12-0-0), tal funcionalidade deixou de ser experimental, estando dispon√≠vle de forma nativa no Cypress üéä

Teu exerc√≠cio extra √©:

1. Atualize o comando customizado de _login_ para que agora sejam dois comandos (`guiLogin` e `sessionLogin`), conforme abaixo:

```js
// cypress/support/commands.js

// ... Comando de signup aqui

Cypress.Commands.add('guiLogin', (
  username = Cypress.env('USER_EMAIL'),
  password = Cypress.env('USER_PASSWORD')
) => {
  cy.intercept('GET', '**/notes').as('getNotes')
  cy.visit('/login')
  cy.get('#email').type(username)
  cy.get('#password').type(password, { log: false })
  cy.contains('button', 'Login').click()
  cy.wait('@getNotes')
  cy.contains('h1', 'Your Notes').should('be.visible')
})

Cypress.Commands.add('sessionLogin', (
  username = Cypress.env('USER_EMAIL'),
  password = Cypress.env('USER_PASSWORD')
) => {
  const login = () => cy.guiLogin(username, password)
  cy.session(username, login)
})

```

> **Obs. 4:** Observe que agora temos um comando para fazer o login via GUI e outro para fazer o login usando o comando `cy.session`, o qual, quando executado pela primeira vez, ir√° fazer o login via GUI, no entanto, nas proximas execu√ß√µes, tal comando ir√° restaurar a sess√£o do usu√°rio, n√£o perdendo tempo via GUI.

2. Atualize o arquivo `cypress/e2e/login.cy.js` para que este fa√ßa uso do comando `cy.guiLogin()`, em vez do `cy.login()`. Al√©m disso, remova do mesmo a defini√ß√£o do `cy.intercept` e `cy.wait`, visto que estes foram movidos para o comando customizado.
3. Execute o teste ap√≥s a refatora√ß√£o para garantir que tudo continua funcionando (`npx cypress run --spec cypress/e2e/login.cy.js`).

### Conte√∫dos relacionados ü§ì

Recentemente criei alguns conte√∫dos sobre o assunto e vou deixar aqui como material de consulta auxiliar:

- [Autentique testes mais r√°pido com o comando cy.session](https://talkingabouttesting.com/2021/08/07/autentique-testes-mais-rapido-com-o-comando-cy-session/)
- [_Playlist_ `cy.session` no Canal TAT no YouTube](https://youtube.com/playlist?list=PL-eblSNRj0QF1RA4fd9FrDVov_uyYfCAL)

## Mostre ao mundo o que voc√™ aprendeu

Como forma de demonstrar √† sua rede profissioinal seus novos aprendizados, poste o seguinte no LinkedIn.

> **Estou fazendo o curso de [testes _end-to-end_ com Cypress](https://www.udemy.com/course/testes-end-to-end-com-cypress/?referralCode=BFC58FC7B29F2F37904D) da Escola TAT no Udemy, onde aprendi como proteger dados sens√≠veis, criar comandos customizados, al√©m de otimizar o processo de autentica√ß√£o com o uso da funcionalidade `cy.session()`. #TalkingAboutTesting #EscolaTAT #Cypress**

**Observa√ß√£o:** Lembre de me marcar em sua publica√ß√£o. Segue [meu perfil no LinkedIn](https://www.linkedin.com/in/walmyr-lima-e-silva-filho).

___

Mais uma funcionalidade com seu cen√°rio de caminho feliz coberto. üëç

V√° para a [aula 4](./4.md) e vamos testar o CRUD (_**C**reate, **R**ead, **U**pdate, **D**elete_) de anota√ß√µes.
